

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Source: model/mongooseRequest.js | SWEDesigner API</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-jsdoc.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/tui-doc.css">

    
</head>
<body>
<nav class="lnb" id="lnb">
    <div class="logo" style="width: auto; height: auto">
        <img src="https://github.com/SWEetBIT/SWEDesigner--Documentazione/blob/master/common/logo%20trasparente.png?raw=true" width="100%" height="100%">
    </div>
    <div class="title">
        <h1><a href="index.html" class="link">SWEDesigner API</a></h1>
        
    </div>
    <div class="search-container" id="search-container">
        <input type="text" placeholder="Search">
        <ul></ul>
    </div>
    
    <div class="lnb-api hidden"><h3>Modules</h3><ul><li><a href="module-encrypt.html">encrypt</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:encrypt_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-encrypt.html#~decrypt">decrypt</a></li><li><a href="module-encrypt.html#~encrpyt">encrpyt</a></li><li><a href="module-encrypt.html#~getIv">getIv</a></li><li><a href="module-encrypt.html#~getKey">getKey</a></li></ul></div></li><li><a href="module-encryptService.html">encryptService</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:encryptService_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-encryptService.html#~decrypt">decrypt</a></li><li><a href="module-encryptService.html#~encrpyt">encrpyt</a></li><li><a href="module-encryptService.html#~getIv">getIv</a></li><li><a href="module-encryptService.html#~getKey">getKey</a></li></ul></div></li><li><a href="module-midLoader.html">midLoader</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:midLoader_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-midLoader.html#~parse/load">parse/load</a></li></ul></div></li><li><a href="module-mongooseRequest.html">mongooseRequest</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:mongooseRequest_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-mongooseRequest.html#~drop_schema">drop_schema</a></li><li><a href="module-mongooseRequest.html#~ins_crypt_param">ins_crypt_param</a></li><li><a href="module-mongooseRequest.html#~load_keyCrypt">load_keyCrypt</a></li></ul></div></li><li><a href="module-moongoseConnection.html">moongoseConnection</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:moongoseConnection_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-moongoseConnection.html#~conn">conn</a></li></ul></div></li><li><a href="module-parse.html">parse</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:parse_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-parse.html#~getTemplate">getTemplate</a></li><li><a href="module-parse.html#~load">load</a></li><li><a href="module-parse.html#~parse">parse</a></li></ul></div></li><li><a href="module-parseService.html">parseService</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:parseService_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-parseService.html#~parsing">parsing</a></li></ul></div></li><li><a href="module-serverLoader.html">serverLoader</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:serverLoader_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-serverLoader.html#~load">load</a></li><li><a href="module-serverLoader.html#~loadCryptParam">loadCryptParam</a></li></ul><div class="member-type">Typedef</div><ul class="inner"><li><a href="module-serverLoader.html#~cryptLoad">cryptLoad</a></li><li><a href="module-serverLoader.html#~cryptQuery">cryptQuery</a></li></ul></div></li></ul></div><div class="lnb-api hidden"><h3>Classes</h3><ul><li><a href="keyschema.html">keyschema</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="keyschema_sub"></div></li></ul></div><div class="lnb-api hidden"><h3>Global</h3><ul><li><a href="global.html#app/post/decrypt">app/post/decrypt</a></li><li><a href="global.html#app/post/encrypt">app/post/encrypt</a></li><li><a href="global.html#app/post/parsing">app/post/parsing</a></li><li class="hidden"><a href="global.html#keysReturned">keysReturned</a></li><li class="hidden"><a href="global.html#ParseCB">ParseCB</a></li><li><a href="global.html#server/load">server/load</a></li></ul></div>
</nav>
<div id="resizer"></div>

<div class="main" id="main">
    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @module mongooseRequest
 * @description
 * This module manage the query to MongoDB
 * @see module:moongoseConnection
 */

//Istanziazione schemi
var cryptSchema = require('./cryptKeySchema');
var projectSchema = require('./projectsSchema');
var userSchema = require('./usersSchema');

var mongoose = require('mongoose');	
var proget= mongoose.model('Progetto', proget);
var chiave= mongoose.model('key', chiave);	
var user = mongoose.model('utente', user);

//connessione database
var db = mongoose.connection;

//QUERY --DA SISTEMARE--
/*ins_usr: function(data, cb){
    //Funzione di inserimento utente, ritorna true se l'inserimento è andato a buon fine, false altrimenti
  var ins= new user({
      username: data.username,
      pass: req.body.pass,
      email: req.body.email
  });
  ins.save(function(err) {
  if (err) {
      cb(err, null);
  }
  else{
     cb(false, ins);
  }
  });
},*/

module.exports ={
//INSERIMENTI
ins_usr: function(){
  app.post('/ins_utente',function(req,res){	//Funzione di inserimento utente, ritorna true se l'inserimento è andato a buon fine, false altrimenti
  var ins= new user({
      username: req.body.username,
      pass: req.body.pass,
      email: req.body.email
  });
  ins.save(function(err) {
  if (err) {
      console.log(err);
      res.send(false);
  }
  else{
      console.log("Salvataggio utente riuscito: "+ins);
      res.send(true);
  }
  });
});
},
ins_proj: function(){
  app.post('/ins_progetto',function(req,res){	//Funzione di inserimento progetto, ritorna true se l'inserimento è andato a buon fine, false altrimenti
      console.log("Si funziono o forse no");
      var ins= new proget({
      nome_progetto: req.body.nome_progetto,
      username: req.body.username,
      progetto: req.body.progetto
  });
  console.log(ins);
  ins.save(function(err) {
  if (err){
  console.log(err);
  res.send(false);
  }
  else{
      console.log("Salvataggio progetto riuscito: "+ins);
      res.send(true);
  }
});
});
},
/**
 * @function ins_crypt_param
 * @description
 * This query insert into database the crypt values
 * @param {string} k Crypt key
 * @param {string} i iv key
 * @param {cryptQuery} cb The callback that handles the response. 
 * @see keyschema
 */
ins_crypt_param: function(k, i, cb){
      var chiave_cript= new chiave({
          "key_code":k,
          "iv_code":i
          });
          chiave_cript.save(function(err){
          if(err){
              console.log(err);
              //res.send(false);
          }
          else {
              console.log("Salvataggio chiave riuscito: "+chiave_cript);
              //res.send(true);
              cb();
          }
      });
},
// 		FUNZIONI CON RITORNO DATI SALVATI NEL DATABASE
load_allProj: function(){
      app.post('/all_progetti', function(req, res){	//Funzione che ritorna i nomi dei progetti dato un utente
      proget.find({'username': req.body.username},' -_id nome_progetto', function(err, progetti){
      if(err) console.log(err);
      console.log(progetti);
      res.send(progetti);
  });

});
},
/**
* @function load_keyCrypt
* @description
* This query request to database the crypt values
* @param {cryptQuery} cb The callback that handles the response. 
*/
load_keyCrypt: function(cb){
      chiave.find('key_code id_code', function(err, keys){
          if(err){
              console.log(err);
              cb(true, keys);
          }
          else{
              var json = keys.map(function(p){
                      return p.toJSON()
                  })
                  //console.log(json);
                  cb(false, json);
          }
      })        
},
load_proj: function(){
      app.post('/ritorna_progetto', function(req, res){	//Funzione che ritorna un progetto dato un nome progetto e un utente
      proget.findOne({'nome_progetto': req.body.nome_progetto, 'username': req.body.username}, '-_id progetto', function(err, ut){
      if(err) console.log(err);
      console.log(ut);
      res.send(ut);
  });
});
},
login: function(){
      app.post('/conferma_utente', function(req, res){	//Funzione che ritorna true se un utente esistente nel database ha inserito la password corretta e false altrimenti
      user.find({'username': req.body.username, 'pass': req.body.pass}, '-_id username pass', function(err, ut){
      if(err) console.log(err);
      if(ut!=""){
          res.send(true);
          console.log(ut);
      }
      else res.send(false);
  });

});
},
forgot_mail: function(){
      app.post('/ritorna_email', function(req, res){
      user.find({'username': req.body.username}, '-_id email', function(err, em){
      if(err) console.log(err);
      res.send(em);
      console.log(em);
  });
});
},
//		FUNZIONI DI AGGIORNAMENTO
update_proj: function(){
      app.post('/aggiorna_progetto', function(req, res){		//Funzione che aggiorna un progetto dato il nome progetto e l'utente, ritorna true se l'aggiornamento è andato a buon fine, false altrimenti
      proget.update({ 'nome_progetto': req.body.nome_progetto, 'username': req.body.username}, { 'progetto': req.body.new_progetto }, function (err, nuovo) {
      if (err) return handleError(err);
      console.log(nuovo);
      if(nuovo.n!=0)res.send(true);
      else res.send(false);
      });
});
},
update_nameProj: function(){
      app.post('/aggiorna_nome_progetto', function(req, res){		//Funzione che aggiorna il nome di un progetto dato il vecchio nome progetto e l'username utente, ritorna true se l'aggiornamento è andato a buon fine, false altrimenti
      proget.update({ 'nome_progetto': req.body.nome_progetto, 'username': req.body.username}, { 'nome_progetto': req.body.new_nome }, function (err, nuovo) {
      if (err) return handleError(err);
      console.log(nuovo);
      if(nuovo.n!=0) res.send(true);
      else res.send(false);
      });
});
},
update_username: function(){
      app.post('/aggiorna_username', function(req, res){		//Funzione che aggiorna un username dato un vecchio username utente, ritorna true se l'aggiornamento è andato a buon fine, false altrimenti (Modifica anche tutti gli username nei progetti con l'utente in questione)
      var usern= req.body.username;
      var nusern= req.body.new_username;
      user.update({ 'username': usern}, { 'username': nusern}, function (err, nuovo) {
      if (err) return handleError(err);
      console.log(nuovo);
      if(nuovo.n!=0){
          proget.update({'username': usern},{ 'username': nusern},{multi: true}, function(err, controllo){
              if(err) console.log(err);
          });
          res.send(true);
          }
      else res.send(false);
      });
  });
},
update_pwd: function(){
      app.post('/aggiorna_password', function(req, res){		//Funzione che aggiorna una password utente dato un username, ritorna true se l'aggiornamento è andato a buon fine, false altrimenti
      user.update({ 'username': req.body.username}, { 'pass': req.body.new_password }, function (err, nuovo) {
      if (err) return handleError(err);
      console.log(nuovo);
      if(nuovo.n!=0)res.send(true);
      else res.send(false);
      });

});
},
update_mail: function(){
      app.post('/aggiorna_email', function(req, res){			//Funzione che aggiorna un indirizzo email dato un username utente, ritorna true se l'aggiornamento è andato a buon fine, false altrimenti
      user.update({ 'username': req.body.username}, { 'email': req.body.new_email }, function (err, nuovo) {
      if (err) return handleError(err);
      console.log(nuovo);
      if(nuovo.n!=0)res.send(true);
      else res.send(false);
      });
});
},
//		FUNZIONI DI ELIMINAZIONE DATI
delete_proj: function(){
      app.post('/elimina_progetto', function(req, res){		//Funzione che elimina un progetto dato il nome del progetto e il nome dell'utente, ritorna true se l'eliminazione è andato a buon fine, false altrimenti
      proget.findOneAndRemove({'nome_progetto': req.body.nome_progetto, 'username': req.body.username}, function(err, progetti){
          if(err){
              console.log(err);
              res.send(false);
          }
          else{
              console.log("Eliminazione eseguita");
              res.send(true);
          }
      });
});
},
delete_usr: function(){
      app.post('/elimina_utente', function(req, res){		//Funzione che elimina un utente e i suoi progetti dato un username utente, ritorna true se l'eliminazione è andato a buon fine, false altrimenti
      user.findOneAndRemove({'username': req.body.username}, function(err, progetti){
          proget.find({'username': req.body.username}).remove( function(err, progetti){
          if(err){
              console.log(err);
              res.send(false);
          }
          else {
              console.log("Eliminazione eseguita");
              res.send("&lt;h1>&lt;p>Eliminazione progetto riuscita! B)&lt;/p>");
          }
          });
  });
});
},
/**
 * @function drop_schema
 * @description
 * This function delete database
 * @return {void}
 */
drop_schema: function(){
  mongoose.connection.db.dropDatabase(function(err){
  if(err){
      console.log(err);
      console.log("no droppato");
  }
  else{
      console.log("db droppato");
  }
  });
}
}</code></pre>
        </article>
    </section>




</div>

<footer>
    <div class="footer-text">SWEDesigner by SWEet Bit</div>
</footer>
<script>prettyPrint();</script>
<script src="scripts/jquery.min.js"></script>
<script src="scripts/tui-doc.js"></script>
<script src="scripts/linenumber.js"></script>

    <script>
        var id = '_sub'.replace(/"/g, '_');
        var selectedApi = document.getElementById(id); // do not use jquery selector
        var $selectedApi = $(selectedApi);

        $selectedApi.removeClass('hidden');
        $selectedApi.parent().find('.glyphicon').removeClass('glyphicon-plus').addClass('glyphicon-minus');
        showLnbApi();
    </script>

</body>
</html>
